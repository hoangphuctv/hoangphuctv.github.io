<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Markdown Cleaner — 1 Textbox (mobile-friendly)</title>
  <style>
    :root {
      --bg: #f6f8fb;
      --card: #ffffff;
      --accent: #0d6efd;
      --accent-hover: #0849b8;
      --muted: #6b7280;
      --radius: 12px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 18px;
      font-family: "Inter", "Segoe UI", Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, var(--bg), #eef3fb 60%);
      color: #111827;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .container {
      max-width: 820px;
      margin: 0 auto;
      background: var(--card);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: 0 8px 30px rgba(15,23,42,0.08);
    }
    header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }
    h1 {
      font-size:18px;
      margin:0;
      letter-spacing: -0.2px;
    }
    p.lead {
      margin:0;
      color:var(--muted);
      font-size:13px;
    }

    textarea#editor {
      width:100%;
      min-height:260px;
      max-height:60vh;
      padding:12px 14px;
      font-size:15px;
      line-height:1.45;
      border-radius:10px;
      border:1px solid #e6e9ef;
      resize:vertical;
      background: linear-gradient(180deg,#fff,#fbfdff);
      box-shadow: inset 0 1px 0 rgba(0,0,0,0.02);
    }

    .controls {
      display:flex;
      gap:10px;
      margin-top:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    button {
      border: none;
      background: var(--accent);
      color: white;
      padding:10px 14px;
      border-radius:9px;
      font-size:15px;
      cursor:pointer;
      transition: transform .08s ease, background .15s ease;
    }
    button:hover { background: var(--accent-hover); transform: translateY(-1px); }
    button.secondary {
      background: transparent;
      color: var(--accent);
      border: 1px solid #d6e4ff;
      box-shadow: none;
    }
    .small {
      padding:8px 10px;
      font-size:14px;
      border-radius:8px;
    }

    #status {
      margin-left:6px;
      color: #0f172a;
      opacity:0;
      transition: opacity .25s ease;
      font-size:13px;
    }

    footer.tip {
      margin-top:12px;
      color:var(--muted);
      font-size:13px;
    }

    /* Responsive adjustments */
    @media (max-width:600px) {
      textarea#editor { min-height:220px; font-size:15px; }
      header { flex-direction:column; align-items:flex-start; gap:6px; }
      .controls { gap:8px; }
      button { width: 48%; }
      button.full { width:100%; }
    }
  </style>
</head>
<body>
  <div class="container" role="main">
    <header>
      <div>
        <h1>Markdown Cleaner</h1>
        <p class="lead">Dán Markdown vào dưới — nhấn <strong>Làm sạch</strong> để chuyển thành plain text (1 textbox).</p>
      </div>
      <div style="text-align:right;">
        <small style="color:var(--muted)">Giữ hashtag như <code>#tagname</code></small>
      </div>
    </header>

    <textarea id="editor" aria-label="Markdown editor"
      placeholder="Dán nội dung Markdown vào đây. Nhấn 'Làm sạch' để chuyển nội dung trong ô (thao tác in-place), sau đó nhấn 'Copy' để copy kết quả."></textarea>

    <div class="controls" style="margin-bottom:8px;">
      <button id="cleanBtn" class="small" title="Làm sạch Markdown">🧼 Làm sạch</button>
      <button id="copyBtn" class="small secondary" title="Sao chép nội dung">📋 Copy</button>
      <div id="status" aria-live="polite"></div>
    </div>

    <footer class="tip">
      Lưu ý: nút <strong>Làm sạch</strong> sẽ **ghi đè** nội dung trong ô (để tiết kiệm bộ nhớ). Nếu muốn giữ bản gốc, copy ra chỗ khác trước khi làm sạch.
    </footer>
  </div>

  <script>
    // Fix: header regex now requires at least one space after leading #,
    // so "#tagname" (no space) won't be treated as a heading and will be preserved.
    const cleanBtn = document.getElementById('cleanBtn');
    const copyBtn = document.getElementById('copyBtn');
    const editor = document.getElementById('editor');
    const status = document.getElementById('status');
    let statusTimer = null;

    function showStatus(msg, ms = 1800) {
      clearTimeout(statusTimer);
      status.textContent = msg;
      status.style.opacity = '1';
      statusTimer = setTimeout(() => {
        status.style.opacity = '0';
      }, ms);
    }

    function removeMarkdownInPlace() {
      const md = editor.value || '';

      const cleaned = md
        // HEADERS: only remove leading # when followed by at least one space (so hashtags like #tag stay)
        .replace(/^#{1,6}\s+/gm, "")
        // Bold, Italic
        .replace(/(\*\*|__)(.*?)\1/g, "$2")
        .replace(/(\*|_)(.*?)\1/g, "$2")
        // Strikethrough
        .replace(/~~(.*?)~~/g, "$1")
        // Images -> remove entirely
        .replace(/!\[.*?\]\(.*?\)/g, "")
        // Links [text](url) -> keep text
        .replace(/\[([^\]]*?)\]\((?:.*?)\)/g, "$1")
        // Code blocks (fenced and inline)
        .replace(/`{1,3}[\s\S]*?`{1,3}/g, "")
        // Blockquotes
        .replace(/^\s*>\s?/gm, "")
        // Lists
        .replace(/^\s*[-*+]\s+/gm, "")
        .replace(/^\s*\d+\.\s+/gm, "")
        // Horizontal rules
        .replace(/(^|\n)(---|___|\*\*\*)(?=\n|$)/g, "$1")
        // Unescape characters like \# -> #
        .replace(/\\([\\`*_{}[\]()#+\-.!])/g, "$1")
        // Remove trailing spaces at EOL
        .replace(/[ \t]+\n/g, "\n")
        // Limit consecutive blank lines to max 2
        .replace(/\n{3,}/g, "\n\n")
        .trim();

      editor.value = cleaned;
      showStatus('Đã làm sạch ✔');
    }

    async function copyEditorToClipboard() {
      const text = editor.value || '';
      if (!text) {
        showStatus('Không có nội dung để copy', 1500);
        return;
      }
      // try async clipboard
      if (navigator.clipboard && navigator.clipboard.writeText) {
        try {
          await navigator.clipboard.writeText(text);
          showStatus('Đã copy vào clipboard ✔', 1400);
          return;
        } catch (err) {
          // fallback below
        }
      }
      // Fallback using execCommand
      try {
        editor.select();
        const ok = document.execCommand('copy');
        window.getSelection().removeAllRanges();
        if (ok) showStatus('Đã copy ✔', 1400);
        else showStatus('Không copy được', 1400);
      } catch (e) {
        showStatus('Copy không khả dụng trên trình duyệt này', 1600);
      }
    }

    cleanBtn.addEventListener('click', removeMarkdownInPlace);
    copyBtn.addEventListener('click', copyEditorToClipboard);

    // Optional: Ctrl/Cmd+Enter to clean quickly
    editor.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        removeMarkdownInPlace();
      }
    });
  </script>
</body>
</html>